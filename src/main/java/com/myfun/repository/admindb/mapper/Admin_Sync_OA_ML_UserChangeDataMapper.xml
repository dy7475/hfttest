<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.myfun.repository.admindb.dao.Admin_Sync_OA_ML_UserChangeDataMapper">
  
  <!-- 获取当前员工的职级信息 -->
  <select id="getSyncUserByHftUserId"  parameterType="java.lang.Integer" resultType="com.myfun.repository.admindb.vo.Admin_Sync_OA_ML_UserVO">
	SELECT
		A.BADGE badge,
		A.NAME name,
		A.JOIN_DATE joinDate,
		A.LEAVE_DATE leaveDate,
		A.EMP_STATUS empStatus,
		case 
			when A.EMP_STATUS=1 then '在职'
			when A.EMP_STATUS=2 then '离职'
			when A.EMP_STATUS=3 then '退休'
			when A.EMP_STATUS=4 then '退休'
			else '' end empStatusDesc,
		A.JOB_STATUS jobStatus,
		A.MOBILE mobile,
		A.CERT_NO certNo,
		B.TITLE2 positionName,
		<!-- 职级  -->
		ISNULL(D.HFT_RULE_DESC, '') hftRuleDesc,
		ISNULL(C.ORGANIZATION_NAME, '') orgName
	FROM
		ML_USER A
	LEFT JOIN ML_JOB B ON A.JOB_ID = B.JOB_ID
	LEFT JOIN hft_erpdb_CD..FUN_ORGANIZATION C ON C.ORGANIZATION_ID=A.HFT_ORG_ID
	LEFT JOIN HFT_ML_JOB_MAP D ON A.HFT_COMP_ID = D.HFT_COMP_ID AND A.EMP_GRADE = D.ML_ID
	WHERE
		A.HFT_USER_ID = #{userId}
  </select>

	<!--  获取用户调迁记录  -->
  <select id="getUserTransferList"  parameterType="com.myfun.repository.admindb.param.Admin_Sync_OA_ML_UserChangeDataParam" resultType="com.myfun.repository.admindb.vo.UserTransferVo">
	SELECT * from ( 
	SELECT
		a.C_TYPE AS cType,
		a.C_TYPE_CODE AS typeCode,
		a.CHANGE_TITLE AS changeTitle,
		a.CHANGE_ID AS changeId,
		a.OLD_BAGE AS oldBadge,
		a.BADGE AS badge,
		a.NAME AS name,
		a.CERT_NO AS certNo,
		a.OLD_MOBILE AS oldMobile,
		a.NEW_MOBILE AS newMobile,
		a.CHANGE_DATE AS chageDate,
		<!-- 失效日期，为下一个起效日期的前一天 -->
		(SELECT top 1 dateadd(day,-1,d.CHANGE_DATE)  
			from ML_EMP_CHANGE_DATA d 
			where d.CERT_NO=a.CERT_NO 
			AND d.CHANGE_DATE > a.CHANGE_DATE 
			order by d.CHANGE_DATE DESC 
		) as invalidDate,
		a.OLD_DEP_CODE AS oldEmpCode,
		a.NEW_DEP_CODE AS newEmpCode,
		a.OLD_DEP_ID AS oldDeptId,
		a.NEW_DEP_ID AS newDeptId,
		a.NEW_DEP_ABBR newOrgName,
		a.OLD_DEP_ABBR oldOrgName,
		a.OLD_DEP_MAR_KET AS oldMarket,
		a.OLD_MARKET_NAME AS oldMarketName,
		a.NEW_DEP_MARKET AS newMarket,
		a.NEW_MARKET_NAME AS newMarketName,
		a.OLD_EMPGRADE AS oldEmpGrade,
		a.NEW_EMPGRADE AS newEmpGrade,
		a.JOIN_DATE AS joinDate,
		a.LEAVE_DATE AS leaveDate,
		a.INITIALIZED_TIME AS initializedTime,
		a.OLD_JOB_NAME AS oldJobName,
		a.NEW_JOB_NAME AS newJobName,
		a.E_STATUE AS eStatus,
		a.OLD_QXTYPE_NAME AS oldQxTypeName,
		a.NEW_QXTYPE_NAME AS newQxTypeName,
		a.ORG_PATH AS orgPath
	FROM
	dbo.ML_EMP_CHANGE_DATA AS A
	<!-- 查询指定人员身份证对应的记录  -->
	LEFT JOIN ML_USER B on a.CERT_NO=B.CERT_NO
	<where>
		<if test="typeCode != null">
			AND A.C_TYPE_CODE = #{typeCode}
		</if>
		<if test="changeId != null">
			AND A.CHANGE_ID = #{changeId}
		</if>
		<if test="hftUserId != null ">
			AND B.HFT_USER_ID = #{hftUserId}
		</if>
		 <!-- 查询指定的组织，及其子组织数据 -->
	  	 <if test="organizationId != null"> 
		 	AND A.ORG_PATH LIKE '%/'+(select ID from ML_ORG_TREE t where t.HFT_ORG_ID=#{organizationId} )+'%'
		 </if>
		 <if test="queryDateType == 1">
	 		<if test="queryBeginTime != null"> 
			 	and a.CHANGE_DATE <![CDATA[ >= ]]> convert (varchar(10),#{queryBeginTime},120)
			 </if>
		 	 <if test="queryEndTime != null"> 
			 	and a.CHANGE_DATE <![CDATA[ <= ]]> convert (varchar(10),#{queryEndTime},120)
			 </if>
	 	</if>
	</where>
	) temp
	<!-- 查询失效时间的情况下 -->
	<where>
		<if test="queryDateType == 2">
	 		<if test="queryBeginTime != null"> 
			 	and temp.invalidDate <![CDATA[ >= ]]> convert (varchar(10),#{queryBeginTime},120)
			 </if>
		 	 <if test="queryEndTime != null"> 
			 	and temp.invalidDate <![CDATA[ <= ]]> convert (varchar(10),#{queryEndTime},120)
			 </if>
	 	</if>
	</where>
	 ORDER BY temp.initializedTime  ASC
  </select>
  
</mapper>