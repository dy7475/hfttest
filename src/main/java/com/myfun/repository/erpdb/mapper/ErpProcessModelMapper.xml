<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.myfun.repository.erpdb.dao.ErpProcessModelMapper">
  <resultMap id="BaseResultMap" type="com.myfun.repository.erpdb.po.ErpProcessModel">
    <!--@mbggenerated-->
    <id column="MODEL_ID" jdbcType="INTEGER" property="modelId" />
    <result column="COMP_ID" jdbcType="INTEGER" property="compId" />
    <result column="PRO_NAME" jdbcType="VARCHAR" property="proName" />
    <result column="MODEL_NO" jdbcType="SMALLINT" property="modelNo" />
    <result column="YOU_STATUS" jdbcType="INTEGER" property="youStatus" />
    <result column="CONDITION_STEP_ID" jdbcType="INTEGER" property="conditionStepId" />
    <result column="CONDITION_STEP_IDS" jdbcType="VARCHAR" property="conditionStepIds" />
  </resultMap>
  <sql id="Example_Where_Clause">
    <!--@mbggenerated-->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Update_By_Example_Where_Clause">
    <!--@mbggenerated-->
    <where>
      <foreach collection="example.oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
  <sql id="Base_Column_List">
    <!--@mbggenerated-->
    MODEL_ID, COMP_ID, PRO_NAME, MODEL_NO, YOU_STATUS, CONDITION_STEP_ID, CONDITION_STEP_IDS
  </sql>
  <select id="selectByExample" parameterType="com.myfun.repository.erpdb.po.ErpProcessModelExample" resultMap="BaseResultMap">
    <!--@mbggenerated-->
    select
    <if test="distinct">
      distinct
    </if>
    <include refid="Base_Column_List" />
    from PROCESS_MODEL
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
    <if test="orderByClause != null">
      order by ${orderByClause}
    </if>
  </select>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--@mbggenerated-->
    select 
    <include refid="Base_Column_List" />
    from PROCESS_MODEL
    where MODEL_ID = #{modelId,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--@mbggenerated-->
    delete from PROCESS_MODEL
    where MODEL_ID = #{modelId,jdbcType=INTEGER}
  </delete>
  <delete id="deleteByExample" parameterType="com.myfun.repository.erpdb.po.ErpProcessModelExample">
    <!--@mbggenerated-->
    delete from PROCESS_MODEL
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </delete>
  <insert id="insert" parameterType="com.myfun.repository.erpdb.po.ErpProcessModel">
    <!--@mbggenerated-->
    <selectKey keyProperty="modelId" order="BEFORE" resultType="java.lang.Integer">
      SELECT next value for SEQ_PROCESS_MODEL_MODEL_ID
    </selectKey>
    insert into PROCESS_MODEL (MODEL_ID, COMP_ID, PRO_NAME, 
      MODEL_NO, YOU_STATUS, CONDITION_STEP_ID, 
      CONDITION_STEP_IDS)
    values (#{modelId,jdbcType=INTEGER}, #{compId,jdbcType=INTEGER}, #{proName,jdbcType=VARCHAR}, 
      #{modelNo,jdbcType=SMALLINT}, #{youStatus,jdbcType=INTEGER}, #{conditionStepId,jdbcType=INTEGER}, 
      #{conditionStepIds,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.myfun.repository.erpdb.po.ErpProcessModel">
    <!--@mbggenerated-->
    <selectKey keyProperty="modelId" order="BEFORE" resultType="java.lang.Integer">
      SELECT next value for SEQ_PROCESS_MODEL_MODEL_ID
    </selectKey>
    insert into PROCESS_MODEL
    <trim prefix="(" suffix=")" suffixOverrides=",">
      MODEL_ID,
      <if test="compId != null">
        COMP_ID,
      </if>
      <if test="proName != null">
        PRO_NAME,
      </if>
      <if test="modelNo != null">
        MODEL_NO,
      </if>
      <if test="youStatus != null">
        YOU_STATUS,
      </if>
      <if test="conditionStepId != null">
        CONDITION_STEP_ID,
      </if>
      <if test="conditionStepIds != null">
        CONDITION_STEP_IDS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      #{modelId,jdbcType=INTEGER},
      <if test="compId != null">
        #{compId,jdbcType=INTEGER},
      </if>
      <if test="proName != null">
        #{proName,jdbcType=VARCHAR},
      </if>
      <if test="modelNo != null">
        #{modelNo,jdbcType=SMALLINT},
      </if>
      <if test="youStatus != null">
        #{youStatus,jdbcType=INTEGER},
      </if>
      <if test="conditionStepId != null">
        #{conditionStepId,jdbcType=INTEGER},
      </if>
      <if test="conditionStepIds != null">
        #{conditionStepIds,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <select id="countByExample" parameterType="com.myfun.repository.erpdb.po.ErpProcessModelExample" resultType="java.lang.Integer">
    <!--@mbggenerated-->
    select count(*) from PROCESS_MODEL
    <if test="_parameter != null">
      <include refid="Example_Where_Clause" />
    </if>
  </select>
  <update id="updateByExampleSelective" parameterType="map">
    <!--@mbggenerated-->
    update PROCESS_MODEL
    <set>
      <if test="record.modelId != null">
        MODEL_ID = #{record.modelId,jdbcType=INTEGER},
      </if>
      <if test="record.compId != null">
        COMP_ID = #{record.compId,jdbcType=INTEGER},
      </if>
      <if test="record.proName != null">
        PRO_NAME = #{record.proName,jdbcType=VARCHAR},
      </if>
      <if test="record.modelNo != null">
        MODEL_NO = #{record.modelNo,jdbcType=SMALLINT},
      </if>
      <if test="record.youStatus != null">
        YOU_STATUS = #{record.youStatus,jdbcType=INTEGER},
      </if>
      <if test="record.conditionStepId != null">
        CONDITION_STEP_ID = #{record.conditionStepId,jdbcType=INTEGER},
      </if>
      <if test="record.conditionStepIds != null">
        CONDITION_STEP_IDS = #{record.conditionStepIds,jdbcType=VARCHAR},
      </if>
    </set>
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByExample" parameterType="map">
    <!--@mbggenerated-->
    update PROCESS_MODEL
    set MODEL_ID = #{record.modelId,jdbcType=INTEGER},
      COMP_ID = #{record.compId,jdbcType=INTEGER},
      PRO_NAME = #{record.proName,jdbcType=VARCHAR},
      MODEL_NO = #{record.modelNo,jdbcType=SMALLINT},
      YOU_STATUS = #{record.youStatus,jdbcType=INTEGER},
      CONDITION_STEP_ID = #{record.conditionStepId,jdbcType=INTEGER},
      CONDITION_STEP_IDS = #{record.conditionStepIds,jdbcType=VARCHAR}
    <if test="_parameter != null">
      <include refid="Update_By_Example_Where_Clause" />
    </if>
  </update>
  <update id="updateByPrimaryKeySelective" parameterType="com.myfun.repository.erpdb.po.ErpProcessModel">
    <!--@mbggenerated-->
    update PROCESS_MODEL
    <set>
      <if test="compId != null">
        COMP_ID = #{compId,jdbcType=INTEGER},
      </if>
      <if test="proName != null">
        PRO_NAME = #{proName,jdbcType=VARCHAR},
      </if>
      <if test="modelNo != null">
        MODEL_NO = #{modelNo,jdbcType=SMALLINT},
      </if>
      <if test="youStatus != null">
        YOU_STATUS = #{youStatus,jdbcType=INTEGER},
      </if>
      <if test="conditionStepId != null">
        CONDITION_STEP_ID = #{conditionStepId,jdbcType=INTEGER},
      </if>
      <if test="conditionStepIds != null">
        CONDITION_STEP_IDS = #{conditionStepIds,jdbcType=VARCHAR},
      </if>
    </set>
    where MODEL_ID = #{modelId,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.myfun.repository.erpdb.po.ErpProcessModel">
    <!--@mbggenerated-->
    update PROCESS_MODEL
    set COMP_ID = #{compId,jdbcType=INTEGER},
      PRO_NAME = #{proName,jdbcType=VARCHAR},
      MODEL_NO = #{modelNo,jdbcType=SMALLINT},
      YOU_STATUS = #{youStatus,jdbcType=INTEGER},
      CONDITION_STEP_ID = #{conditionStepId,jdbcType=INTEGER},
      CONDITION_STEP_IDS = #{conditionStepIds,jdbcType=VARCHAR}
    where MODEL_ID = #{modelId,jdbcType=INTEGER}
  </update>
  
  <insert id="insertInitCompProcessModel">
    delete from PROCESS_MODEL
    where COMP_ID = #{compId,jdbcType=INTEGER}
    INSERT INTO PROCESS_MODEL(MODEL_ID,COMP_ID,PRO_NAME,MODEL_NO)
	SELECT (NEXT VALUE FOR SEQ_PROCESS_MODEL_MODEL_ID) AS MODEL_ID,${compId},PRO_NAME,MODEL_NO
	FROM PROCESS_MODEL WHERE COMP_ID = 0 AND YOU_STATUS=0
   </insert>
  
   <insert id="insertInitCompProcessModelStepByCompId"> 
    delete from PROCESS_MODEL_STEP
    where COMP_ID = #{compId,jdbcType=INTEGER}
   	INSERT INTO
	PROCESS_MODEL_STEP(STEP_ID,STEP_NAME,COMP_ID,TIMELIMIT_TYPE,TIMELIMIT,EXECUTOR_TYPE,EXECUTOR,EXECUTOR_NAME,EXECUTOR_ROLE,WARN_TYPE,WARNER,WARNER_NAME,WARNER_ROLE,IS_SYSTEM,RPEVSTEP_ID,RPEVSTEP_NAME,STEP_NO)
	SELECT (NEXT VALUE FOR SEQ_PROCESS_MODEL_STEP_STEP_ID) AS STEP_ID,STEP_NAME,${compId},TIMELIMIT_TYPE,TIMELIMIT,EXECUTOR_TYPE,EXECUTOR,EXECUTOR_NAME,EXECUTOR_ROLE,WARN_TYPE,WARNER,WARNER_NAME,WARNER_ROLE,IS_SYSTEM,RPEVSTEP_ID,RPEVSTEP_NAME,STEP_NO
	FROM PROCESS_MODEL_STEP
	WHERE COMP_ID = 0
   </insert>
   <insert id="insertInitCompModelStepRelateByCompId"> 
   delete from MODEL_STEP_RELATE where COMP_ID= #{compId}
   INSERT INTO MODEL_STEP_RELATE(MODEL_ID,STEP_ID,COMP_ID,STEP_SEQ)
	SELECT
	(SELECT top 1 MODEL_ID FROM PROCESS_MODEL WHERE PROCESS_MODEL.MODEL_NO=MODEL_STEP_RELATE_SETTING.MODEL_NO AND COMP_ID=${compId}) MODEL_ID,
	(SELECT top 1 STEP_ID FROM PROCESS_MODEL_STEP WHERE PROCESS_MODEL_STEP.STEP_NO=MODEL_STEP_RELATE_SETTING.STEP_NO AND COMP_ID=${compId}) STEP_ID,
	${compId}, MODEL_STEP_RELATE_SETTING.STEP_SEQ FROM MODEL_STEP_RELATE_SETTING
   </insert>
  <select id="selectProcessModelListByCompId" resultType="java.util.Map">
	WITH T_MODEL_STEP_RELATE AS (
		SELECT
			MODEL_ID,
			COUNT (1) AS STEP_COUNT
		FROM
			MODEL_STEP_RELATE
		WHERE
			comp_id = #{compId} group BY MODEL_ID
	) SELECT
		A.MODEL_ID as modelId,A.COMP_ID as compId,A.PRO_NAME as proName,A.MODEL_NO as modelNo,A.YOU_STATUS as youStatus, B.STEP_COUNT as stepCount, A.CONDITION_STEP_ID as conditionStepId,A.CONDITION_STEP_IDS as conditionStepIds
	FROM
		PROCESS_MODEL A
	LEFT JOIN T_MODEL_STEP_RELATE B ON A.MODEL_ID = B.MODEL_ID
	WHERE
		A.COMP_ID = #{compId}
	ORDER BY
		MODEL_NO OFFSET (${pageOffset}-1)*${pageRows} ROW FETCH NEXT ${pageRows} ROWS ONLY
  </select>

  <select id="getSerialNumber" resultType="java.util.Map">
      select MIN(MODEL_NO) minValue, MAX(MODEL_NO) maxValue from PROCESS_MODEL where  COMP_ID=#{compId}
  </select>
  <select id="getNowInsertModelId" resultType="java.lang.Integer">
    SELECT MAX (MODEL_ID) FROM PROCESS_MODEL
  </select>
	<select id="getMinMaxVal" resultType="java.util.Map">
		select
		MIN(MODEL_NO) minValue,MAX(MODEL_NO) maxValue
		from  PROCESS_MODEL where  COMP_ID =#{compId}
	</select>
  <update id="updateConditionStepIdToNull">
    update PROCESS_MODEL set CONDITION_STEP_ID = null where MODEL_ID=#{modelId} and comp_id=#{compId}
    <if test="null != conditionStepId">
      and CONDITION_STEP_ID=#{conditionStepId}
    </if>

  </update>
  <select id="getModelByDealId" resultMap="BaseResultMap">
    select a.* from PROCESS_MODEL a
    join fun_deal b on a.MODEL_ID = b.MODEL_ID
    where b.deal_id = #{dealId}
  </select>
</mapper>